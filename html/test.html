<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>3D 球形热力地球</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #tooltip {
            position: absolute;
            background: #fff;
            padding: 5px;
            border: 1px solid #ccc;
            pointer-events: none;
            opacity: 0;
            font-size: 12px;
        }

        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #aaa;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="tooltip"></div>
    <div id="legend"></div>

    <script>
        const width = 960;
        const height = 600;

        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoOrthographic()
            .scale(280)
            .translate([width / 2, height / 2])
            .rotate([0, -30])
            .clipAngle(90);

        const path = d3.geoPath().projection(projection);
        const colorScale = d3.scaleSequential(d3.interpolateYlOrRd);

        // 创建 Sphere 背景
        svg.append("path")
            .datum({ type: "Sphere" })
            .attr("class", "sphere")
            .attr("d", path)
            .attr("fill", "#e0f7fa")
            .attr("stroke", "#666")
            .attr("stroke-width", 0.5);

        // 拖拽旋转功能
        let rotate = [0, -30];
        svg.call(d3.drag().on("drag", (event) => {
            rotate[0] += event.dx * 0.5;
            rotate[1] -= event.dy * 0.5;
            projection.rotate(rotate);
            updatePaths();
        }));

        // 缩放功能
        svg.call(d3.zoom().on("zoom", (event) => {
            const newScale = event.transform.k * 280;
            projection.scale(newScale);
            updatePaths();
        }));

        // 数据加载
        Promise.all([
            d3.csv("../data/data_country_region_cleaned.csv"),
            d3.csv("../data/average_papers_per_country.csv"),
            d3.json("../data/world.zh.json")
        ]).then(([countryMapping, paperData, worldData]) => {
            const nameToIso = {};
            countryMapping.forEach(row => {
                nameToIso[row.Country.trim()] = row.Code.trim().toUpperCase();
            });

            const papersByIso = {};
            paperData.forEach(row => {
                const iso = nameToIso[row.Country.trim()];
                if (iso) papersByIso[iso] = +row.Papers;
            });

            const values = Object.values(papersByIso);
            colorScale.domain([d3.min(values), d3.max(values)]);

            const countries = worldData.features;

            const countryPaths = svg.selectAll("path.country")
                .data(countries)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("fill", d => {
                    const iso = d.properties.iso_a3;
                    const val = papersByIso[iso];
                    return val !== undefined ? colorScale(val) : "#ccc";
                })
                .attr("stroke", "#000")
                .attr("stroke-width", 0.3)
                .on("mouseover", (event, d) => {
                    const iso = d.properties.iso_a3;
                    const value = papersByIso[iso];
                    const name = d.properties.name;
                    d3.select("#tooltip")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px")
                        .style("opacity", 1)
                        .html(`<strong>${name}</strong><br/>发文量: ${value ?? "无数据"}`);
                })
                .on("mouseout", () => {
                    d3.select("#tooltip").style("opacity", 0);
                });

            // 自动旋转地球
            d3.timer((elapsed) => {
                rotate[0] += 0.05;
                projection.rotate(rotate);
                updatePaths();
            });

            // 图例
            createLegend(d3.min(values), d3.max(values));

            // 路径更新函数
            function updatePaths() {
                svg.select("path.sphere").attr("d", path);
                countryPaths.attr("d", path);
            }

            function createLegend(min, max) {
                const steps = 8;
                const legendWidth = 240;
                const legendScale = d3.scaleLinear().domain([0, steps]).range([min, max]);

                const legendSvg = d3.select("#legend").append("svg")
                    .attr("width", legendWidth)
                    .attr("height", 40);

                const rectWidth = legendWidth / steps;
                for (let i = 0; i < steps; i++) {
                    const val = legendScale(i);
                    legendSvg.append("rect")
                        .attr("x", i * rectWidth)
                        .attr("y", 0)
                        .attr("width", rectWidth)
                        .attr("height", 15)
                        .attr("fill", colorScale(val));
                }

                // 标签
                legendSvg.append("text")
                    .attr("x", 0)
                    .attr("y", 30)
                    .text(Math.round(min));

                legendSvg.append("text")
                    .attr("x", legendWidth - 30)
                    .attr("y", 30)
                    .text(Math.round(max));
            }

        });
    </script>
</body>

</html>